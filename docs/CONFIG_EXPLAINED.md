# Gi·∫£i Th√≠ch √ù Nghƒ©a C√°c C·∫•u H√¨nh

## üìã T·ªïng Quan

Project c√≥ **3 lo·∫°i config ch√≠nh**:
1. **Config File (JSON/TOML)** - C·∫•u h√¨nh processing pipeline
2. **GPT Config (YAML)** - C·∫•u h√¨nh cho AI translators
3. **Environment Variables (.env)** - API keys v√† connection settings

---

## üîß Config File (JSON/TOML)

### 1. Translator Config

```json
{
  "translator": {
    "translator": "gemini",        // D·ªãch v·ª• s·ª≠ d·ª•ng
    "target_lang": "VIN",          // Ng√¥n ng·ªØ ƒë√≠ch
    "no_text_lang_skip": false,    // Skip text ƒë√£ l√† ng√¥n ng·ªØ ƒë√≠ch
    "skip_lang": null,             // B·ªè qua c√°c ng√¥n ng·ªØ c·ª• th·ªÉ
    "gpt_config": null,            // Path to GPT config file
    "translator_chain": null,      // Chu·ªói translator
    "selective_translation": null  // Ch·ªçn translator theo ng√¥n ng·ªØ
  }
}
```

**√ù nghƒ©a:**
- **translator**: Ch·ªçn d·ªãch v·ª• d·ªãch (gemini, deepseek, nllb, etc.)
- **target_lang**: Ng√¥n ng·ªØ mu·ªën d·ªãch SANG (VIN = Ti·∫øng Vi·ªát)
- **no_text_lang_skip**: N·∫øu text ƒë√£ l√† ng√¥n ng·ªØ ƒë√≠ch ‚Üí c√≥ d·ªãch l·∫°i kh√¥ng?
- **skip_lang**: B·ªè qua n·∫øu detect ng√¥n ng·ªØ n√†o ƒë√≥ (vd: `"JPN,ENG"`)
- **translator_chain**: D√πng nhi·ªÅu translator li√™n ti·∫øp (vd: `"google:JPN;sugoi:ENG"`)

---

### 2. Detector Config

```json
{
  "detector": {
    "detector": "default",         // Model ph√°t hi·ªán text
    "detection_size": 2048,        // K√≠ch th∆∞·ªõc x·ª≠ l√Ω
    "text_threshold": 0.5,         // Ng∆∞·ª°ng ph√°t hi·ªán text
    "box_threshold": 0.75,         // Ng∆∞·ª°ng bounding box
    "unclip_ratio": 2.3,           // T·ª∑ l·ªá m·ªü r·ªông bbox
    "det_rotate": false,           // C√≥ xoay ·∫£nh kh√¥ng
    "det_auto_rotate": false,      // T·ª± ƒë·ªông xoay theo text
    "det_invert": false,           // ƒê·∫£o m√†u
    "det_gamma_correct": false     // S·ª≠a gamma
  }
}
```

**√ù nghƒ©a:**
- **detector**: Model n√†o ph√°t hi·ªán text
  - `default`: DBNet (t·ªët cho ƒëa m·ª•c ƒë√≠ch)
  - `ctd`: T·ªët h∆°n cho manga
  - `paddle`: PaddleOCR detector
  
- **detection_size**: K√≠ch th∆∞·ªõc ·∫£nh resize tr∆∞·ªõc khi detect (2048 = full size)
  - Nh·ªè h∆°n ‚Üí Nhanh nh∆∞ng b·ªè s√≥t text nh·ªè
  - L·ªõn h∆°n ‚Üí Ch·∫≠m nh∆∞ng detect t·ªët h∆°n

- **text_threshold**: ƒê·ªô "ch·∫Øc ch·∫Øn" ph√°t hi·ªán l√† text (0.0-1.0)
  - 0.3 = Ph√°t hi·ªán nhi·ªÅu (c√≥ th·ªÉ sai)
  - 0.7 = Ch·ªâ ph√°t hi·ªán ch·∫Øc ch·∫Øn
  - 0.5 = C√¢n b·∫±ng

- **box_threshold**: Ng∆∞·ª°ng t·∫°o bounding box
  - Cao h∆°n = √çt box h∆°n (ch·∫Øc ch·∫Øn h∆°n)
  - Th·∫•p h∆°n = Nhi·ªÅu box h∆°n (c√≥ th·ªÉ c√≥ noise)

---

### 3. OCR Config

```json
{
  "ocr": {
    "ocr": "48px",                 // Model OCR
    "use_mocr_merge": false,       // Merge bbox trong Manga OCR
    "min_text_length": 0,         // ƒê·ªô d√†i text t·ªëi thi·ªÉu
    "ignore_bubble": 0            // B·ªè qua text ngo√†i bubble
  }
}
```

**√ù nghƒ©a:**
- **ocr**: Model nh·∫≠n d·∫°ng text
  - `48px`: T·ªët cho Chinese, Japanese
  - `32px`: Basic, nhanh h∆°n
  - `mocr`: Manga OCR (r·∫•t t·ªët cho manga)
  
- **min_text_length**: B·ªè qua text ng·∫Øn h∆°n N k√Ω t·ª±
- **ignore_bubble**: B·ªè qua text kh√¥ng trong bubble (1-50, khuy√™n d√πng 5-10)

---

### 4. Inpainter Config

```json
{
  "inpainter": {
    "inpainter": "lama_large",     // Model x√≥a text
    "inpainting_size": 2048,       // K√≠ch th∆∞·ªõc x·ª≠ l√Ω
    "inpainting_precision": "bf16" // ƒê·ªô ch√≠nh x√°c
  }
}
```

**√ù nghƒ©a:**
- **inpainter**: Model n√†o x√≥a text c≈©
  - `lama_large`: Ch·∫•t l∆∞·ª£ng cao, ch·∫≠m
  - `lama_mpe`: Nhanh h∆°n
  - `sd`: Stable Diffusion (r·∫•t ch·∫≠m)
  
- **inpainting_size**: K√≠ch th∆∞·ªõc ·∫£nh khi x√≥a text
  - 2048 = Chu·∫©n
  - 1024 = Nhanh h∆°n, ch·∫•t l∆∞·ª£ng k√©m
  - 4096 = Ch·∫•t l∆∞·ª£ng cao h∆°n, OOM risk

- **inpainting_precision**: ƒê·ªô ch√≠nh x√°c t√≠nh to√°n
  - `bf16`: C√¢n b·∫±ng t·ªëc ƒë·ªô/ch·∫•t l∆∞·ª£ng
  - `fp32`: Ch·∫•t l∆∞·ª£ng cao nh·∫•t, ch·∫≠m
  - `fp16`: Nhanh nh∆∞ng k√©m ch√≠nh x√°c

---

### 5. Render Config

```json
{
  "render": {
    "renderer": "default",         // C√°ch ch√®n text
    "alignment": "auto",           // CƒÉn ch·ªânh
    "font_size_offset": 0,         // ƒêi·ªÅu ch·ªânh size font
    "font_size_minimum": -1,       // Font size t·ªëi thi·ªÉu
    "direction": "auto",           // H∆∞·ªõng text
    "uppercase": false,            // Vi·∫øt hoa t·∫•t c·∫£
    "lowercase": false,            // Vi·∫øt th∆∞·ªùng t·∫•t c·∫£
    "disable_font_border": false,  // B·ªè vi·ªÅn ch·ªØ
    "font_color": null,            // M√†u ch·ªØ (hex)
    "line_spacing": null,          // Kho·∫£ng c√°ch d√≤ng
    "rtl": false                   // Ph·∫£i sang tr√°i
  }
}
```

**√ù nghƒ©a:**
- **renderer**: C√°ch render text
  - `default`: C∆° b·∫£n
  - `manga2eng`: Th√¥ng minh, t·ª± fit v√†o bubble
  - `none`: Kh√¥ng render (ch·ªâ inpaint)
  
- **font_size_offset**: TƒÉng/gi·∫£m font size
  - `+10`: L·ªõn h∆°n 10px
  - `-5`: Nh·ªè h∆°n 5px

- **alignment**: CƒÉn ch·ªânh text trong box
  - `auto`: T·ª± ƒë·ªông ph√°t hi·ªán
  - `left`: Tr√°i
  - `center`: Gi·ªØa
  - `right`: Ph·∫£i

- **direction**: H∆∞·ªõng text
  - `auto`: T·ª± ƒë·ªông
  - `horizontal`: Ngang
  - `vertical`: D·ªçc (cho Chinese/Japanese)

- **font_color**: M√†u ch·ªØ
  - Format: `"FFFFFF:000000"` (foreground:background)
  - VD: `"FFFFFF"` = tr·∫Øng, `":000000"` = n·ªÅn ƒëen

---

### 6. Upscale Config

```json
{
  "upscale": {
    "upscaler": "esrgan",          // Model ph√≥ng to
    "upscale_ratio": null,         // T·ª∑ l·ªá ph√≥ng to
    "revert_upscaling": false      // C√≥ thu nh·ªè l·∫°i sau khi d·ªãch
  }
}
```

**√ù nghƒ©a:**
- **upscaler**: Model ph√≥ng to ·∫£nh
  - `esrgan`: Ch·∫•t l∆∞·ª£ng t·ªët
  - `waifu2x`: Chuy√™n cho anime/manga
  - `4xultrasharp`: Si√™u n√©t
  
- **upscale_ratio**: T·ª∑ l·ªá ph√≥ng to (2 = x2, 4 = x4)
  - Gi√∫p detect text nh·ªè t·ªët h∆°n
  - VD: Text nh·ªè ‚Üí `upscale_ratio: 2` tr∆∞·ªõc detect

- **revert_upscaling**: C√≥ thu nh·ªè l·∫°i v·ªÅ k√≠ch th∆∞·ªõc g·ªëc kh√¥ng?

---

### 7. Colorizer Config

```json
{
  "colorizer": {
    "colorizer": "none",            // C√≥ t√¥ m√†u kh√¥ng
    "colorization_size": 576,      // K√≠ch th∆∞·ªõc t√¥ m√†u
    "denoise_sigma": 30            // ƒê·ªô nhi·ªÖu
  }
}
```

**√ù nghƒ©a:**
- **colorizer**: Model t√¥ m√†u
  - `none`: Kh√¥ng t√¥ m√†u (gi·ªØ nguy√™n)
  - `mc2`: T√¥ m√†u cho manga ƒëen tr·∫Øng
  
- **colorization_size**: K√≠ch th∆∞·ªõc khi t√¥ m√†u
- **denoise_sigma**: ƒê·ªô l√†m m·ªãn (0-255, 30 = m·∫∑c ƒë·ªãnh)

---

## ü§ñ GPT Config (YAML) - Cho AI Translators

File: `examples/gpt_config-example.yaml`

### 1. Temperature & Top_p

```yaml
temperature: 0.5     # ƒê·ªô "s√°ng t·∫°o" (0.0-2.0)
top_p: 0.95          # Nucleus sampling (0.0-1.0)
```

**√ù nghƒ©a:**
- **temperature**: Ki·ªÉm so√°t ƒë·ªô ng·∫´u nhi√™n
  - `0.0-0.3`: R·∫•t t·∫≠p trung, nh·∫•t qu√°n
  - `0.5-0.7`: C√¢n b·∫±ng
  - `0.8-2.0`: S√°ng t·∫°o, ƒëa d·∫°ng h∆°n
  
- **top_p**: Ch·ªçn top N% tokens c√≥ x√°c su·∫•t cao nh·∫•t
  - `0.1`: Ch·ªâ l·∫•y top 10% tokens
  - `0.95`: L·∫•y 95% tokens

### 2. Chat System Template

```yaml
chat_system_template: >
  You are a professional translation engine.
  Translate text to {to_lang}.
  Maintain tone and meaning.
```

**√ù nghƒ©a:**
- Prompt h∆∞·ªõng d·∫´n AI c√°ch d·ªãch
- `{to_lang}`: Placeholder cho ng√¥n ng·ªØ ƒë√≠ch
- C√†ng chi ti·∫øt ‚Üí Translation c√†ng t·ªët
- N√™n include: Role, Method, Rules

### 3. Chat Samples

```yaml
chat_sample:
  English: 
    - <|1|>Original text 1
      <|2|>Original text 2
    - <|1|>Translated text 1
      <|2|>Translated text 2
```

**√ù nghƒ©a:**
- V√≠ d·ª• input-output m·∫´u ƒë·ªÉ AI h·ªçc style
- Format: `<|ID|>text` v·ªõi c√πng ID
- Gi√∫p AI hi·ªÉu c√°ch d·ªãch phong c√°ch n√†y

### 4. JSON Mode

```yaml
json_mode: false              # B·∫≠t JSON mode
json_sample:                  # V√≠ d·ª• cho JSON mode
  Simplified Chinese:
    - TextList:
        - ID: 1
          text: "Original"
    - TextList:
        - ID: 1
          text: "Translated"
```

**√ù nghƒ©a:**
- **json_mode**: D√πng JSON format thay v√¨ text
  - Ch√≠nh x√°c h∆°n
  - Ch·ªâ Gemini h·ªó tr·ª£ t·ªët
  
- **json_sample**: V√≠ d·ª• JSON ƒë·ªÉ AI h·ªçc
  - ID ph·∫£i kh·ªõp nhau
  - Format chu·∫©n ƒë·ªÉ AI parse

### 5. Model-specific Config

```yaml
chatgpt:
  gpt-4o-mini:
    temperature: 0.4
  
gemini:
  temperature: 0.5
  top_p: 0.95
```

**√ù nghƒ©a:**
- C·∫•u h√¨nh ri√™ng cho t·ª´ng model
- Override settings m·∫∑c ƒë·ªãnh
- Cho ph√©p t·ªëi ∆∞u cho t·ª´ng AI

---

## üåê Environment Variables (.env)

### API Keys

```bash
# GEMINI
GEMINI_API_KEY='AIzaSy...'
GEMINI_MODEL='gemini-1.5-flash-002'

# DEEPSEEK
DEEPSEEK_API_KEY='sk-...'
DEEPSEEK_API_BASE='https://api.deepseek.com'
DEEPSEEK_MODEL='deepseek-chat'

# GROQ
GROQ_API_KEY='gsk_...'
GROQ_MODEL='mixtral-8x7b-32768'

# OPENAI
OPENAI_API_KEY='sk-...'
OPENAI_API_BASE='https://api.openai.com/v1'
OPENAI_MODEL='gpt-4o-mini'
```

**√ù nghƒ©a:**
- **API_KEY**: Key ƒë·ªÉ authenticate v·ªõi service
- **MODEL**: Model AI n√†o s·ª≠ d·ª•ng
- **API_BASE**: URL endpoint (cho custom servers)

### Glossary & Dictionary

```bash
OPENAI_GLOSSARY_PATH='./dict/mit_glossary.txt'
SAKURA_DICT_PATH='./dict/sakura_dict.txt'
```

**√ù nghƒ©a:**
- File t·ª´ ƒëi·ªÉn/thu·∫≠t ng·ªØ
- Gi√∫p d·ªãch nh·∫•t qu√°n (t√™n ri√™ng, thu·∫≠t ng·ªØ)
- Format: `original = translation`

---

## üìñ Complete Example: Chinese ‚Üí Vietnamese

### Config File: `config.json`
```json
{
  "translator": {
    "translator": "gemini",
    "target_lang": "VIN"
  },
  "detector": {
    "detector": "default",
    "detection_size": 2048
  },
  "ocr": {
    "ocr": "48px"
  },
  "inpainter": {
    "inpainter": "lama_large",
    "inpainting_size": 2048
  },
  "render": {
    "renderer": "default",
    "font_size_offset": 5,
    "alignment": "auto",
    "direction": "auto"
  },
  "upscale": {
    "upscaler": "esrgan",
    "upscale_ratio": null
  },
  "kernel_size": 3,
  "mask_dilation_offset": 30
}
```

### Environment: `.env`
```bash
GEMINI_API_KEY='AIzaSy...your_key'
GEMINI_MODEL='gemini-1.5-flash-002'
```

### Command
```bash
python -m manga_translator local \
    -i ./chinese_images \
    --config-file config.json \
    --use-gpu
```

---

## üéØ Gi·∫£i Th√≠ch C√°c Tham S·ªë Quan Tr·ªçng

### `kernel_size` (Line 973-976 in config.py)
```json
"kernel_size": 3
```
**√ù nghƒ©a**: K√≠ch th∆∞·ªõc kernel ƒë·ªÉ x√≥a ph·∫ßn c√≤n th·ª´a c·ªßa text
- S·ªë l·∫ª: 3, 5, 7
- C√†ng l·ªõn ‚Üí X√≥a m·∫°nh h∆°n (c√≥ th·ªÉ l√†m m·∫•t detail)
- 3 = M·∫∑c ƒë·ªãnh (c√¢n b·∫±ng)

### `mask_dilation_offset` (Line 978-981)
```json
"mask_dilation_offset": 30
```
**√ù nghƒ©a**: M·ªü r·ªông mask ƒë·ªÉ ch·∫Øc ch·∫Øn che h·∫øt text c≈©
- TƒÉng l√™n n·∫øu text b·ªã "l·ªô" sau inpainting
- 10-30 = Ph·∫°m vi an to√†n
- L·ªõn h∆°n ‚Üí Mask l·ªõn h∆°n ‚Üí V√πng x√≥a l·ªõn h∆°n

### `no_text_lang_skip` (Line 222)
```json
"no_text_lang_skip": false
```
**√ù nghƒ©a**: C√≥ d·ªãch text ƒë√£ l√† ng√¥n ng·ªØ ƒë√≠ch kh√¥ng?
- `false`: B·ªè qua text ƒë√£ l√† VIN
- `true`: D·ªãch l·∫°i t·∫•t c·∫£ (k·ªÉ c·∫£ ƒë√£ l√† VIN)

### `skip_lang` (Line 224)
```json
"skip_lang": "JPN,ENG"
```
**√ù nghƒ©a**: B·ªè qua n·∫øu detect l√† ng√¥n ng·ªØ n√†y
- VD: `"JPN,ENG"` ‚Üí Kh√¥ng d·ªãch n·∫øu l√† Japanese/English
- D√πng khi mu·ªën ch·ªâ d·ªãch t·ª´ Chinese

---

## üìä Config Priority

```
Command line > Config file > Default values
```

V√≠ d·ª•:
```bash
# Command line override
--translator gemini --target-lang VIN --font-size-offset 10

# Config file
{
  "translator": { "translator": "nllb", "target_lang": "ENG" },
  "render": { "font_size_offset": 5 }
}

# Result: gemini, VIN, +10 (CLI wins)
```

---

## üîó Reference

- **Config schema**: `manga_translator/config.py`
- **GPT config**: `examples/gpt_config-example.yaml`
- **Examples**: `examples/config-example.json`
- **API keys**: `examples/Example.env`

---

*Complete config explanation guide*


